name: CI Pipeline

on:
  push:
    branches:
      - lernia-dev
      - 'iteration*'
  pull_request:
    branches:
      - lernia-dev
      - 'iteration*'

jobs:
  backend-unit-tests:
    name: Backend Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run Unit Tests
        run: mvn test -Dtest='**.*Test'
        working-directory: ./backend

  backend-build:
    name: Build Java Backend
    runs-on: ubuntu-latest
    needs: backend-unit-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build Backend Artifact
        run: mvn -B clean package
        working-directory: ./backend

      - name: Upload Backend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: backend/target/*.jar

  frontend:
    name: Build Angular Frontend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Dependencies
        run: npm ci
        working-directory: ./frontend
      - name: Run Frontend Unit Tests
        run: npm run test -- --watch=false --browsers=ChromeHeadless
        working-directory: ./frontend

      - name: Build Frontend
        run: npm run build
        working-directory: ./frontend

      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/

  acceptance-tests:
    name: Run Acceptance Tests
    runs-on: ubuntu-latest
    needs: [ backend-build, frontend ]
    env:
      HEADLESS: "true"
      APP_BASE_URL: "http://localhost:4200"
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: npm ci
        working-directory: ./frontend

      - name: Start frontend server in background
        run: |
          npm run start &
          npx wait-on --timeout 30000 http://localhost:4200
        working-directory: ./frontend

      - name: Install geckodriver (for Firefox)
        run: |
          sudo apt-get update
          sudo apt-get install -y firefox jq
          GECKO_TAG=$(curl -s https://api.github.com/repos/mozilla/geckodriver/releases/latest | jq -r .tag_name)
          curl -L -o geckodriver.tar.gz "https://github.com/mozilla/geckodriver/releases/download/${GECKO_TAG}/geckodriver-${GECKO_TAG}-linux64.tar.gz"
          tar -xzf geckodriver.tar.gz
          sudo mv geckodriver /usr/local/bin/geckodriver
          sudo chmod +x /usr/local/bin/geckodriver
          echo "GECKODRIVER_PATH=/usr/local/bin/geckodriver" >> $GITHUB_ENV

      - name: Start backend server in background
        run: |
          mvn spring-boot:run &
          npx wait-on --timeout 60000 http://localhost:8080
        working-directory: ./backend

      - name: Run acceptance tests
        run: mvn test
        working-directory: ./acceptance-tests

      - name: Stop servers
        run: |
          lsof -ti :4200 | xargs kill -9 || true
          lsof -ti :8080 | xargs kill -9 || true
